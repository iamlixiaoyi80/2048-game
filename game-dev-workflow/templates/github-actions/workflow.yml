name: Game CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_VERSION: 2023.2.0f1

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [StandaloneWindows64, StandaloneOSX, StandaloneLinux64]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Cache Unity Library
      uses: actions/cache@v3
      with:
        path: Library
        key: Library-${{ matrix.target }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
        restore-keys: |
          Library-${{ matrix.target }}-

    - name: Activate Unity License
      uses: game-ci/unity-activate@v2
      with:
        license: ${{ secrets.UNITY_LICENSE }}

    - name: Build Game
      uses: game-ci/unity-builder@v2
      with:
        targetPlatform: ${{ matrix.target }}
        buildName: MyGame-${{ matrix.target }}
        buildsPath: build
        versioning: Semantic

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Build-${{ matrix.target }}
        path: build

  # æµ‹è¯•ä»»åŠ¡
  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Activate Unity License
      uses: game-ci/unity-activate@v2

    - name: Run Unity Tests
      uses: game-ci/unity-test-runner@v2
      with:
        testMode: all
        artifactsPath: TestResults
        coverageOptions: 'generateAdditionalMetrics;generateHtmlReport;generateCoberturaReport'

    - name: Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: Test Results
        path: TestResults

    - name: Check Coverage
      run: |
        # æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦è¾¾æ ‡ï¼ˆ80%ï¼‰
        echo "æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡..."
        if [ -f TestResults/*.cobertura.xml ]; then
          COVERAGE=$(find TestResults -name "*.cobertura.xml" -exec grep -oP 'line-rate="\K[0-9.]+' {} \; | head -1)
          echo "å½“å‰è¦†ç›–ç‡: ${COVERAGE}"
          COV_NUM=$(echo "$COVERAGE" | awk '{printf "%d", $1 * 100}')
          if [ $COV_NUM -lt 80 ]; then
            echo "âŒ è¦†ç›–ç‡ä½äº80%é˜ˆå€¼"
            exit 1
          else
            echo "âœ… è¦†ç›–ç‡è¾¾æ ‡"
          fi
        fi

  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Linters
      run: |
        npm install -g eslint
        npm install -g csharpier

    - name: Run Linters
      run: |
        # æ£€æŸ¥C#ä»£ç æ ¼å¼
        find Assets -name "*.cs" -exec dotnet-csharpier --check {} +

        # æ£€æŸ¥JavaScriptä»£ç ï¼ˆå¦‚æœæœ‰ï¼‰
        find Assets -name "*.js" -exec eslint {} +

  # éƒ¨ç½²ä»»åŠ¡
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'workflow_dispatch'

    steps:
    - name: Download Build Artifact
      uses: actions/download-artifact@v3
      with:
        name: Build-StandaloneWindows64

    - name: Prepare Deployment
      run: |
        echo "å‡†å¤‡éƒ¨ç½²åˆ° ${{ inputs.environment }} ç¯å¢ƒ"

        # æ ¹æ®ç¯å¢ƒè®¾ç½®å˜é‡
        case "${{ inputs.environment }}" in
          dev)
            DEPLOY_PATH="/var/dev/games/"
            ;;
          staging)
            DEPLOY_PATH="/var/staging/games/"
            ;;
          production)
            DEPLOY_PATH="/var/www/games/"
            ;;
        esac

        echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"

    - name: Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          BACKUP_DIR="${{ secrets.DEPLOY_PATH }}backup.$(date +%Y%m%d_%H%M%S)"
          cp -r ${{ secrets.DEPLOY_PATH }} $BACKUP_DIR

          # éƒ¨ç½²æ–°ç‰ˆæœ¬
          rm -rf ${{ secrets.DEPLOY_PATH }}*
          cp -r MyGame-StandaloneWindows64/* ${{ secrets.DEPLOY_PATH }}

          # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™5ä¸ªï¼‰
          ls -td ${{ secrets.DEPLOY_PATH }}backup.* | tail -n +6 | xargs rm -rf

    - name: Health Check
      run: |
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10

        # å¥åº·æ£€æŸ¥
        case "${{ inputs.environment }}" in
          dev)
            curl -f http://dev.yourgame.com/health || exit 1
            ;;
          staging)
            curl -f http://staging.yourgame.com/health || exit 1
            ;;
          production)
            curl -f https://yourgame.com/health || exit 1
            ;;
        esac

        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"

    - name: Notify Success
      if: success()
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸåˆ° ${{ inputs.environment }}"
        # ä½¿ç”¨cronå‘é€é€šçŸ¥ï¼ˆéœ€è¦clawdbotæ”¯æŒï¼‰
        # clawdbot cron wake --text "æ¸¸æˆå·²éƒ¨ç½²åˆ°${{ inputs.environment }}" --mode now

    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥"
        # clawdbot cron wake --text "éƒ¨ç½²åˆ°${{ inputs.environment }}å¤±è´¥ï¼Œè¯·æ£€æŸ¥" --mode now

  # æ€§èƒ½æµ‹è¯•
  performance:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'workflow_dispatch' && inputs.environment == 'staging'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Download Build Artifact
      uses: actions/download-artifact@v3
      with:
        name: Build-StandaloneWindows64

    - name: Setup Performance Testing
      run: |
        # å®‰è£…æ€§èƒ½æµ‹è¯•å·¥å…·
        npm install -g lighthouse

        # è¿è¡Œæ€§èƒ½æµ‹è¯•
        echo "è¿è¡Œæ€§èƒ½æµ‹è¯•..."

    - name: Upload Performance Report
      uses: actions/upload-artifact@v3
      with:
        name: Performance Report
        path: lighthouse-report.html
